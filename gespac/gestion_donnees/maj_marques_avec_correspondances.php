<?PHP	// on ouvre un fichier en écriture pour les log sql	$fp = fopen('../dump/log_sql.sql', 'a+');	$corr_log = fopen('../dump/correspondances_inexistantes.csv', 'w+');	include_once ('../includes.php');	// fichier contenant les fonctions, la config pear, les mdp databases ...		// adresse de connexion à la base de données	$dsn_gespac	= 'mysql://'. $user .':' . $pass . '@localhost/gespac';	// cnx à la base de données OCS	$db_gespac 	= & MDB2::factory($dsn_gespac);		$log = "";	$array_marque_suppr = array();	//Va contenir les indices des marques supprimées	$array_corr_inexistantes = array();	//Va contenir les log des marques inexistantes			$liste_marques = $db_gespac->queryAll ('SELECT marque_id, marque_type, marque_stype, marque_marque, marque_model FROM marques;');		// pour chaque marque de la base	foreach ($liste_marques as $marque) {			$marque_id 		= $marque[0];		$marque_type 	= $marque[1];		$marque_stype 	= $marque[2];		$marque_marque 	= $marque[3];		$marque_modele 	= $marque[4];				// Si la marque n'est pas supprimée précédement		if ( !in_array($marque_id, $array_marque_suppr) ) {					$log .= "Marque $marque_id | $marque_type | $marque_stype | $marque_marque | $marque_modele <br>";						$liste_correspondances = $db_gespac->queryAll("SELECT corr_marque_ocs, corr_type, corr_stype, corr_marque, corr_modele FROM correspondances WHERE corr_marque_ocs = '$marque_marque" . " " . "$marque_modele'");						// Si la marque existe dans la table des correspondances			if ( $liste_correspondances ) {							$type_corr 		= $liste_correspondances[0][1];				$stype_corr  	= $liste_correspondances[0][2];				$marque_corr  	= $liste_correspondances[0][3];				$modele_corr  	= $liste_correspondances[0][4];								$log .= "La correspondance existe >> Mise à jour de la marque ID $marque_id avec $type_corr  | $stype_corr  | $marque_corr  | $modele_corr  <br>";								$rq_maj_marque = "UPDATE marques SET marque_type='$type_corr', marque_stype='$stype_corr', marque_marque='$marque_corr', marque_model='$modele_corr' WHERE marque_id=$marque_id; ";				$result = $db_gespac->exec ( $rq_maj_marque );								// On log la requête SQL				fwrite($fp, date("Ymd His") . " " . $rq_maj_marque."\n");							// Je regarde si la correspondance s'applique à d'autres lignes de la table marques :				foreach ($liste_marques as $marque) {					$current_id 	= $marque[0];					$current_type 	= $marque[1];					$current_stype 	= $marque[2];					$current_marque = $marque[3];					$current_modele = $marque[4];								// On ne regarde pas la marque en cours					if ( $current_id <> $marque_id ) {														//$log .= "Je compare $marque_id avec $current_id ($current_type | $current_stype | $current_marque | $current_modele) <br>";												$liste_correspondances_marque_courante = $db_gespac->queryAll("SELECT corr_marque_ocs, corr_type, corr_stype, corr_marque, corr_modele FROM correspondances WHERE corr_marque_ocs = '$current_marque" . " " . "$current_modele'");						// Si la marque existe dans la table des correspondances						if ( $liste_correspondances_marque_courante ) {													$type_marque_courante = $liste_correspondances_marque_courante[0][1];							$stype_marque_courante = $liste_correspondances_marque_courante[0][2];							$marque_marque_courante = $liste_correspondances_marque_courante[0][3];							$modele_marque_courante = $liste_correspondances_marque_courante[0][4];														// Si jamais cette marque 							if ($type_corr  == $type_marque_courante && $stype_corr  == $stype_marque_courante && $marque_corr  == $marque_marque_courante && $modele_corr  == $modele_marque_courante) {								$log .= " >> La marque $current_id (avec $current_type | $current_stype | $current_marque | $current_modele) est identique à $marque_id <br>";																$rq_maj_materiels = "UPDATE materiels SET marque_id=$marque_id WHERE marque_id=$current_id; ";								$result = $db_gespac->exec ( $rq_maj_materiels );																// On log la requête SQL								fwrite($fp, date("Ymd His") . " " . $rq_maj_materiels."\n");								$log .= " >> J'update les matos avec le marque_id=$current_id en marque_id=$marque_id<br>";																$rq_suppr_marque = "UPDATE marques SET marque_suppr=1 WHERE marque_id=$current_id; ";								$result = $db_gespac->exec ( $rq_suppr_marque );																// On log la requête SQL								fwrite($fp, date("Ymd His") . " " . $rq_suppr_marque."\n");								$log .= " >> Je mets le marque_suppr=1 pour la marque_id=$current_id<br>";																// Je colle dans un tableau les marque_id des marques supprimées								array_push ($array_marque_suppr, $current_id);							}						}					}							} // foreach						} else {				$log .= "La correspondance n'existe PAS >> Pas de mise à jour de la marque.<br>";				//fputcsv($corr_log, array($marque_marque, $marque_modele), ';' );				array_push ($array_corr_inexistantes, '"' . $marque_marque . '";"' . $marque_modele . '"' );			}						} // if $test_marque_suppr		else {			$log .= "La marque $marque_id est supprimée, je la saute donc...<br>";		}				$log .= "------------------------------------------------<br>";		} // foreach marques		$array_corr_inexistantes_unique =  array_unique($array_corr_inexistantes);		foreach($array_corr_inexistantes_unique as $ligne)		fwrite($corr_log, $ligne."\n");		echo $log;?>