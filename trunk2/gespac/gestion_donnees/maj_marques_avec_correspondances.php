<?PHP	// on ouvre un fichier en écriture pour les log sql	$fp = fopen('../dump/log_sql.sql', 'a+');	$corr_log = fopen('../dump/correspondances_inexistantes.csv', 'w+');	// lib	require_once ('../fonctions.php');	include_once ('../config/databases.php');	include_once ('../../class/Sql.class.php');		// cnx gespac	$con_gespac = new Sql($host, $user, $pass, $gespac);		$log = "";	$array_marque_suppr = array();	//Va contenir les indices des marques supprimées	$array_corr_inexistantes = array();	//Va contenir les log des marques inexistantes			$liste_marques = $con_gespac->QueryAll ('SELECT marque_id, marque_type, marque_stype, marque_marque, marque_model FROM marques;');		// pour chaque marque de la base	foreach ($liste_marques as $marque) {			$marque_id 		= $marque['marque_id'];		$marque_type 	= $marque['marque_type'];		$marque_stype 	= $marque['marque_stype'];		$marque_marque 	= $marque['marque_marque'];		$marque_modele 	= $marque['marque_model'];				// Si la marque n'est pas supprimée précédement		if ( !in_array($marque_id, $array_marque_suppr) ) {					$log .= "Marque $marque_id | $marque_type | $marque_stype | $marque_marque | $marque_modele <br>";						$liste_correspondances = $con_gespac->QueryRow("SELECT corr_marque_ocs, corr_type, corr_stype, corr_marque, corr_modele FROM correspondances WHERE corr_marque_ocs = '$marque_marque" . " " . "$marque_modele'");						// Si la marque existe dans la table des correspondances			if ( $liste_correspondances ) {							$type_corr 		= $liste_correspondances[1];				$stype_corr  	= $liste_correspondances[2];				$marque_corr  	= $liste_correspondances[3];				$modele_corr  	= $liste_correspondances[4];								$log .= "La correspondance existe >> Mise à jour de la marque ID $marque_id avec $type_corr  | $stype_corr  | $marque_corr  | $modele_corr  <br>";								$rq_maj_marque = "UPDATE marques SET marque_type='$type_corr', marque_stype='$stype_corr', marque_marque='$marque_corr', marque_model='$modele_corr' WHERE marque_id=$marque_id; ";				$result = $con_gespac->Execute ( $rq_maj_marque );								// On log la requête SQL				fwrite($fp, date("Ymd His") . " " . $rq_maj_marque."\n");							// Je regarde si la correspondance s'applique à d'autres lignes de la table marques :				foreach ($liste_marques as $marque) {					$current_id 	= $marque['marque_id'];					$current_type 	= $marque['marque_type'];					$current_stype 	= $marque['marque_stype'];					$current_marque = $marque['marque_marque'];					$current_modele = $marque['marque_model'];								// On ne regarde pas la marque en cours					if ( $current_id <> $marque_id ) {														//$log .= "Je compare $marque_id avec $current_id ($current_type | $current_stype | $current_marque | $current_modele) <br>";												$liste_correspondances_marque_courante = $con_gespac->QueryRow("SELECT corr_marque_ocs, corr_type, corr_stype, corr_marque, corr_modele FROM correspondances WHERE corr_marque_ocs = '$current_marque" . " " . "$current_modele'");						// Si la marque existe dans la table des correspondances						if ( $liste_correspondances_marque_courante ) {													$type_marque_courante = $liste_correspondances_marque_courante[1];							$stype_marque_courante = $liste_correspondances_marque_courante[2];							$marque_marque_courante = $liste_correspondances_marque_courante[3];							$modele_marque_courante = $liste_correspondances_marque_courante[4];														// Si jamais cette marque 							if ($type_corr  == $type_marque_courante && $stype_corr  == $stype_marque_courante && $marque_corr  == $marque_marque_courante && $modele_corr  == $modele_marque_courante) {								$log .= " >> La marque $current_id (avec $current_type | $current_stype | $current_marque | $current_modele) est identique à $marque_id <br>";																$rq_maj_materiels = "UPDATE materiels SET marque_id=$marque_id WHERE marque_id=$current_id; ";								$result = $con_gespac->Execute ( $rq_maj_materiels );																// On log la requête SQL								fwrite($fp, date("Ymd His") . " " . $rq_maj_materiels."\n");								$log .= " >> J'update les matos avec le marque_id=$current_id en marque_id=$marque_id<br>";																$rq_suppr_marque = "UPDATE marques SET marque_suppr=1 WHERE marque_id=$current_id; ";								$result = $con_gespac->Execute ( $rq_suppr_marque );																// On log la requête SQL								fwrite($fp, date("Ymd His") . " " . $rq_suppr_marque."\n");								$log .= " >> Je mets le marque_suppr=1 pour la marque_id=$current_id<br>";																// Je colle dans un tableau les marque_id des marques supprimées								array_push ($array_marque_suppr, $current_id);							}						}					}							} // foreach						} else {				$log .= "La correspondance n'existe PAS >> Pas de mise à jour de la marque.<br>";								array_push ($array_corr_inexistantes, '"' . $marque_marque . '";"' . $marque_modele . '"' );			}						} // if $test_marque_suppr		else {			$log .= "La marque $marque_id est supprimée, je la saute donc...<br>";		}				$log .= "------------------------------------------------<br>";		} // foreach marques		$array_corr_inexistantes_unique =  array_unique($array_corr_inexistantes);		foreach($array_corr_inexistantes_unique as $ligne)		fwrite($corr_log, $ligne."\n");		echo $log;?>